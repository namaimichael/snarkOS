version: 2
jobs:
  build:
    machine:
      - image: ubuntu-2004:2022.10.1
    environment:
      DOCKER_BUILDKIT: 1
      BUILDX_PLATFORMS: 'linux/arm64/v8,linux/amd64'
      IMAGE_NAME: namaimichael/snarkos
    docker:
      - image: docker:dind
    steps:
      - checkout
      - setup_remote_docker:
          version: 18.09.3
      - run: docker version
      - run: sudo apt-get update \
             && sudo apt-get install -y curl \
             && sudo rm -rf /var/lib/apt/lists/*
      - run: mkdir -vp ~/.docker/cli-plugins/
      - run: >-
          curl --silent -L --output ~/.docker/cli-plugins/docker-buildx
          https://github.com/docker/buildx/releases/download/v0.3.1/buildx-v0.3.1.linux-amd64
      - run: chmod a+x ~/.docker/cli-plugins/docker-buildx
      - run: docker buildx version
      - run: |
          docker buildx build \
            --platform $BUILDX_PLATFORMS \
            --tag $IMAGE_NAME:testnet3-latest .
      - run:
          name: Archive Docker image
          command: docker save -o image.tar $IMAGE_NAME
      - persist_to_workspace:
          root: .
          paths:
            - ./image.tar
  publish-latest:
    machine:
      - image: ubuntu-2004:2022.10.1
    docker:
      - image: docker:dind
    steps:
#       - setup_remote_docker:
#           version: 18.09.3
      - attach_workspace:
          at: /tmp/workspace
      - run:
          name: Load archived Docker image
          command: docker load -i /tmp/workspace/image.tar
      - run:
          name: Publish Docker Image to Docker Hub
          command: >
            echo "$DOCKER_HUB_PASSWORD" | docker login -u "$DOCKER_HUB_USER"
            --password-stdin 
      - run: |
          docker buildx build --push \
            --platform $BUILDX_PLATFORMS \
            --tag $IMAGE_NAME:testnet3-latest .
workflows:
  version: 2
  build-master:
    jobs:
      - build:
          filters:
            branches:
              only: testnet3
      - publish-latest:
          requires:
            - build
          filters:
            branches:
              only: testnet3
